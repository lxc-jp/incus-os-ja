# バックアップ／リストアー

IncusOSは設定と状態でシステムレベルでバックアップできます。このバックアップは後の時点でリストアーできます。さらに、ファクトリーリセットも可能です。これはIncusOSをあたかもインストール直後のようなまっさらな状態に
戻します。

```{important}
システムレベルのバックアップはインストールされたアプリケーションの情報は含みません。各アプリケーションはそれぞれ固有のバックアップ／リストアーの機能を持っており、システムレベルのバックアップと合わせて使うことで、包括的なシステムのバックアップを作成できます。
```

## バックアップ

```{important}
Incusのバックアップは現在の状態に加えてストレージプールの暗号鍵のコピーも含みます。そのため、バックアップは公開アクセス可能な場所に保管すべきではありません。
```

バックアップを作成するには以下のコマンドを実行します。

```
incus admin os system backup backup.tar.gz
```

## リストアー

```{warning}
バックアップをリストアーすると既存のOSレベルの状態と潜在的には1つ以上の暗号鍵を上書きします。そのため、リストアーする際は注意してください。
```

### 設定オプション

設定フィールドは[`SystemReset`構造体](https://github.com/lxc/incus-os/blob/main/incus-osd/api/system_reset.go)で定義されています。

以下の「スキップ」オプションがバックアップをリストアーする際に指定できます：

* `encryption-recovery-keys`: メインシステムドライブの暗号リカバリー鍵を上書きしない。

* `local-data-encryption-key`: `local`ストレージプールの暗号鍵を上書きしない。

* `network-macs`: バックアップに含まれるハードコードされたMACアドレスを使用せず、既存のインターフェースから適切なMACアドレスを決定することを試みる。

### 例

バックアップをリストアーするには以下のコマンドを実行します。

```
incus admin os system restore backup.tar.gz
```

## ファクトリーリセット

```{warning}
ファクトリーリセットはメインシステムドライブのすべてのデータを消去します。これはインストールされたアプリケーションとその設定そしてシステムレベルの状態を設定を含みます。

ユーザーが作成したプールは変更されませんが、システムがリブートした際にインポートはできません。ファクトリーリセットを実行する__前に__各ストレージプールの暗号鍵を持っていることを確認してください。
```

### 設定オプション

ファクトリーリセットを実行する際に以下の設定オプションを指定できます：

* `allow_tpm_reset_failure`: `true`の場合、TPMの状態のリセットに失敗しても無視します。

* `seeds`: システムを再起動する直前にシードパーティションに書くシードのマップ。システムが起動後に自身の設定を行う際に既存のシードデータを変更するのに役立ちます。

* `wipe_existing_seeds`: `true`の場合、シードパーティションに存在する既存のすべてのシードデータを消去します。

### 例

既存のすべてのシードデータを再利用するベーシックなリセットを実行するには以下のコマンドを実行します。

```
incus admin os system factory-reset
```

TPMの失敗を許容し、既存のシードを消去し、再起動時にベーシックなIncusアプリケーションを設定するようにリセットを実行するには以下のコマンドを実行します。

```
incus admin os system factory-reset -d '{"allow_tpm_reset_failure":true,"wipe_existing_seeds":true,"seeds":{"incus":{"apply_defaults":true}}}'
```
